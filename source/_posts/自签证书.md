---
title: 自签证书
date: 2017-06-06 23:06:55
tags:
- 证书
- HTTPS
- OpenSSL
categories: 
- 浏览器
---

介绍在 Linux 中用 `OpenSSL` 生成 CA 并签发证书的流程。

<!-- more -->

# 安装

```text
$ sudo apt-get install nginx     ##安装nginx
$ sudo apt-get install openssl      ##安装openssl
$ sudo apt-get install libssl-dev    ##安装openssl开发库
```

安装成功后的目录结构

```text
# nginx
/etc/nginx/
        others   nginx各种文件 略
        sites-available/    证书密钥存放目录
            default   配置HTTPS证书的配置文件

# nginx 启动/关闭
$ sudo /etc/init.d/nginx start/stop/restart
```

```text
# openssl
/etc/ssl/
        certs/      该服务器上的证书存放目录，可以房子自己的证书和内置证书
              ca-bundle.crt    内置信任的证书
        private/    证书密钥存放目录
        openssl.cnf    openssl的CA主配置文件
```

# 创建根证书

## 准备工作

创建签发证书需要的文件目录。

```text
$ sudo ln /usr/lib/ssl/openssl.cnf .       
$ mkdir demoCA                                          
$ cd demoCA                                            
$ mkdir certs crl newcerts                        
$ touch index.txt serial  ##index.txt为空；
                          ##serial必须写入内容，且为字符串格式的数字（比如1111)
```

要确保构建的文件目录符合`openssl.cnf`中的目录结构。

```text
dir = ./demoCA                  # Where everything is kept
certs = $dir/certs              # Where the issued certs are kept
crl_dir = $dir/crl              # Where the issued crl are kept
database = $dir/index.txt       # database index file.
# unique_subject = no           # Set to 'no' to allow creation of
                                # several ctificates with same subject.
new_certs_dir = $dir/newcerts   # default place for new certs.

certificate = $dir/cacert.pem           # The CA certificate
serial = $dir/serial                    # The current serial number
crlnumber = $dir/crlnumber              # the current crl number
                                        # must be commented out to leave a V1 CRL
crl = $dir/crl.pem                      # The current CRL
private_key = $dir/private/cakey.pem    # The private key
RANDFILE = $dir/private/.rand           # private random number file

x509_extensions = usr_cert              # The extentions to add to the cert
```

## 创建根证书

```text
# 创建根证书的私匙
openssl genrsa -out ca.key 2048

# 获得ca.key

# 利用私钥创建根证书
openssl req -new -x509 -days 36500 -key ca.key -out ca.crt -subj \
"/C=CN/ST=Guangdong/L=Shenzhen/O=TX/OU=TEG/CN=tencentserver.yancoder.com"

# /C表示国家(Country)，只能是国家字母缩写，如CN、US等；
# /ST表示州或者省(State/Provice)；
# /L表示城市或者地区(Locality)；
# /O表示组织名(Organization Name)；
# /OU表示组织单元/部门(Organizational Unit Name)名；
# /CN表示服务器域名。

# 获得ca.crt
```

# 签发服务器证书

注：Chrome58及以后版本，要求证书包含SAN(Subject Alternative Name)，需要修改openssl配置文件。

## 修改配置文件

```text
......
[ v3_req ]

# Extensions to add to a certificate request

basicConstraints = CA:FALSE
keyUsage = nonRepudiation, digitalSignature, keyEncipherment

subjectAltName = @alt_names             #这里新增一行，添加SAN信息

[ alt_names ]                           #这里新增一段，配置上一行的alt_names信息

DNS.1 = tencentserver.yancoder.com
......
```

## 签发证书

生成公钥/私钥对 `server.key`

```text
openssl genrsa -out server.key 2048
```

生成证书签名请求 `server.csr`

```text
openssl req -new -key server.key -out server.csr \
    -subj "/C=CN/ST=Guangdong/L=Shenzhen/O=TX/OU=TEG/CN=tencentserver.yancoder.com"
```

签发证书 `server.crt`

```text
openssl ca -extensions v3_req -in /etc/nginx/ssl/server.csr -out /etc/nginx/ssl/server.crt -cert ca.crt -keyfile ca.key -days 365
# 注意添加'-extensions v3_req'，才能让修改的配置生效
```

# Nginx开启HTTPS服务

在nginx配置文件（/etc/nginx/sites-available/default）中添加 `HTTPS server` 指令。

```text
server {
    listen 443;
    server_name tencentserver.yancoder.com;         # 修改域名  
    root /usr/share/nginx/html;
    index index.html index.htm; 
    ssl on;
    ssl_certificate /etc/nginx/ssl/server.crt;      # 修改为签发的证书路径
    ssl_certificate_key /etc/nginx/ssl/server.key;  # 修改为公钥/私钥路径    
    ssl_session_timeout 5m; 
    ssl_protocols SSLv3 TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers "HIGH:!aNULL:!MD5 or HIGH:!aNULL:!MD5:!3DES";
    ssl_prefer_server_ciphers on;   
    location / {
        try_files $uri $uri/ =404;
    }
}
```

# 各种服务器开启HTTPS服务

http://www.itrus.cn/service_13.html

# 添加自签发的SSL证书为受信任的根证书

警告：只有当你确认要安装的安全证书是可以信任的情况下才能安装，否则可能带来严重的安全问题，甚至造成财产损失。

http://cnzhx.net/blog/self-signed-certificate-as-trusted-root-ca-in-windows/

## Windows 添加自签证书

通过单击“开始”按钮，在“搜索”框中键入 `certmgr.msc`，然后按 Enter，打开“证书管理器”。‌ 如果系统提示输入管理员密码或进行确认，则需要键入密码或提供确认。

先展开左边栏里的“受信任的根证书颁发机构”，选中其下的“证书”，然后点击菜单栏的“操作”——>“所有任务”——>“导入”，即可打开证书导入向导。